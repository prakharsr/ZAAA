<mat-toolbar>  
  <mat-toolbar-row>
    <div class="container">
      Create Invoice
    </div>
  </mat-toolbar-row>
</mat-toolbar>

<br>

<form (ngSubmit)="submit()" #invoiceForm="ngForm">
  <div class="container">
    <button type="button" *ngIf="!releaseOrder" mat-raised-button (click)="selectRO()">Search Release Order</button>

    <br>

    <ng-container *ngIf="releaseOrder">
      <div class="row">
        <div class="col-lg">
          <div class="card mb-5 mat-elevation-z3">
            <div class="card-body">
              <div class="mb-3">
                <div class="text-muted small">Release Order No</div>
                <div>{{releaseOrder.releaseOrderNO}}</div>
              </div>
              <div class="mb-3">
                <div class="text-muted small">Release Order Date</div>
                <div>{{releaseOrder.date | date}}</div>
              </div>
              <div class="mb-3">
                <div class="text-muted small">Publication</div>
                <div>{{mediaHouse.pubName}} - {{mediaHouse.address.edition}}</div>
              </div>
              <div class="mb-3">
                <div class="text-muted small">Client</div>
                <div>{{client.orgName}}</div>
              </div>
              <div class="mb-3">
                <div class="text-muted small">Client GSTIN</div>
                <div>{{client.GSTIN.GSTType}} {{client.GSTIN.GSTNo}}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg">
          <div class="card mb-5 mat-elevation-z3">
            <div class="card-body">
              <h6>Ad Details</h6>
              
              <div class="my-3">
                <div class="text-muted small">Categories</div>
                <span *ngIf="releaseOrder.adCategory1">{{releaseOrder.adCategory1}}</span>
                <span *ngIf="releaseOrder.adCategory2">, {{releaseOrder.adCategory2}}</span>
                <span *ngIf="releaseOrder.adCategory3">, {{releaseOrder.adCategory3}}</span>
                <span *ngIf="releaseOrder.adCategory4">, {{releaseOrder.adCategory4}}</span>
                <span *ngIf="releaseOrder.adCategory5">, {{releaseOrder.adCategory5}}</span>
                <span *ngIf="releaseOrder.adCategory6">, {{releaseOrder.adCategory6}}</span>
              </div>
              
              <div class="row">
                <div class="col">
                  <div class="text-muted small">Ad Type</div>
                  <div>{{releaseOrder.adType}}</div>
                </div>
                <div class="col" *ngIf="releaseOrder.adPosition">
                  <div class="text-muted small">Page Position</div>
                  <div>{{releaseOrder.adPosition}}</div>
                </div>
              </div>

              <br>

              <div class="row">
                <div class="col">
                  <div class="text-muted small">Caption</div>
                  <div>{{releaseOrder.caption || '--'}}</div>
                </div>
                <div class="col">
                  <div class="text-muted small">Remark</div>
                  <div>{{releaseOrder.remark || '--'}}</div>
                </div>
              </div>

              <br>

              <div class="row">
                <div class="col">
                  <div class="text-muted small">Ad Scheme Paid</div>
                  <div>{{releaseOrder.adSchemePaid}}</div>
                </div>
                <div class="col">
                  <div class="text-muted small">Ad Scheme Free</div>
                  <div>{{releaseOrder.adSchemeFree}}</div>
                </div>
              </div>

              <br>

              <div class="text-muted small">Final Amount <small>(Gross Amount - Agency Discount + Tax)</small></div>
              <div>₹ {{finalRoAmount}}, <span class="text-muted">Tax:</span> ₹ {{finalRoTaxAmount}} ({{roTaxDisplay}})</div>
            </div>
          </div>
        </div>
      </div>

      <br><br>

      <div>
        <div class="card mb-5 mat-elevation-z3">
          <div class="card-header">
            Select Insertions
          </div>
          <div class="card-body">
            <span class="mr-3 mb-3" *ngFor="let item of availableInsertions">
              <mat-checkbox name="item-checked" [(ngModel)]="item.checked">
                {{toDate(item.insertion.date) | date}}
              </mat-checkbox>
            </span>
          </div>
        </div>
      </div>

      <br>

      <div class="row">
        <div class="col-lg">
          <div class="card mb-5 mat-elevation-z3">
            <div class="card-header">
              Calculations
            </div>
            <div class="card-body">
              <div>Gross Amount : ₹ {{grossAmount}}</div>
              
              <br>

              <div class="row">
                <mat-form-field class="col">
                  <input type="number" matInput placeholder="Commission" name="commission" [(ngModel)]="invoice.extraCharges.amount" required #commissionField="ngModel">
                  <mat-error *ngIf="commissionField.errors && commissionField.errors.required">
                    Commission is required.
                  </mat-error>
                </mat-form-field>
                <div class="col-auto align-self-center">
                  <mat-checkbox name="commission100" [(ngModel)]="invoice.extraCharges.percentage">Percentage</mat-checkbox>
                </div>
              </div>

              <div class="row">
                <mat-form-field class="col">
                  <input type="number" matInput placeholder="Additional Charges" name="additionalCharges" [(ngModel)]="invoice.additionalCharges.amount" required #additionalChargesField="ngModel">
                  <mat-error *ngIf="additionalChargesField.errors && additionalChargesField.errors.required">
                    Additional Charges is required.
                  </mat-error>
                </mat-form-field>
                <div class="col-auto align-self-center">
                  <mat-checkbox name="additionalCharges100" [(ngModel)]="invoice.additionalCharges.percentage">Percentage</mat-checkbox>
                </div>
              </div>
              
              <br>
            
              <div class="row">
                <mat-form-field class="col">
                  <input type="number" matInput placeholder="Publication Discount" name="pubDiscount" [(ngModel)]="invoice.publicationDiscount.amount" required #pubDiscountField="ngModel">
                  <mat-error *ngIf="pubDiscountField.errors && pubDiscountField.errors.required">
                    Publication Discount is required.
                  </mat-error>
                </mat-form-field>
                <div class="col-auto align-self-center">
                  <mat-checkbox name="pubDiscount100" [(ngModel)]="invoice.publicationDiscount.percentage">Percentage</mat-checkbox>
                </div>
              </div>

              <div class="row">
                <mat-form-field class="col">
                  <input type="number" matInput placeholder="Agency Discount" name="agencyDiscount" [(ngModel)]="invoice.agencyDiscount1.amount" required #agencyDiscountField="ngModel">
                  <mat-error *ngIf="agencyDiscountField.errors && agencyDiscountField.errors.required">
                    Agency Discount is required.
                  </mat-error>
                </mat-form-field>
                <div class="col-auto align-self-center">
                  <mat-checkbox name="agencyDiscount100" [(ngModel)]="invoice.agencyDiscount1.percentage">Percentage</mat-checkbox>
                </div>
              </div>

              <br>
          
              <div class="row">
                <div class="col">
                  <label id="add_details">Other Charges</label>
                </div>
                <div class="col-auto">
                  <button mat-raised-button type="button" color="primary" (click)="addCharges()"><mat-icon>add</mat-icon> Add More</button>
                </div>
              </div>
            
              <div class="text-muted" *ngIf="invoice.otherCharges.length == 0">
                No Other Charges
              </div>
        
              <div *ngFor="let item of invoice.otherCharges; index as i" class="mb-1">
                <div class="form-row">
                  <div class="col">
                    <mat-form-field>
                      <input matInput placeholder="Type" name="otherChargesType-{{i}}" [(ngModel)]="item.chargeType" required #otherChargesTypeField="ngModel">
                      <mat-error *ngIf="otherChargesTypeField.errors && otherChargesTypeField.errors.required">
                        Type is required.
                      </mat-error>
                    </mat-form-field>
                  </div>
                  <div class="col">
                    <mat-form-field>
                      <input type="number" matInput placeholder="Amount" name="otherCharges-{{i}}" [(ngModel)]="item.amount" required #otherChargesField="ngModel">
                      <mat-error *ngIf="otherChargesField.errors && otherChargesField.errors.required">
                        Amount is required.
                      </mat-error>
                    </mat-form-field>
                  </div>
                  <div class="col-auto col-form-label">
                    <button mat-icon-button color="warn" type="button" (click)="removeOtherCharge(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              
              <br>
                        
              <div class="form-row">
                <label class="col-auto col-form-label mr-2">Tax</label>
                <div class="col-auto col-form-label">
                  <mat-checkbox name="taxIncluded" [(ngModel)]="invoice.taxIncluded">Included</mat-checkbox>
                </div>
                <div class="col">
                  <div class="form-group">
                    <select class="form-control" name="tax" [(ngModel)]="invoice.taxAmount" id="tax" #taxField="ngModel" required>
                      <option *ngFor="let item of taxes" [ngValue]="item">{{item.primary}}% <span *ngIf="item.secondary">+ {{item.secondary}}%</span></option>
                    </select>
                  </div>
          
                  <div *ngIf="taxField.invalid && (taxField.dirty || taxField.touched)" class="text-danger">
                    <div *ngIf="taxField.errors.required">
                      Tax is required.
                    </div>
                    <br>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <div>Final Amount <small>(Gross Amount + Tax)</small>:  ₹ {{netAmount}}</div>
            </div>
          
            <!-- <div class="form-row">
              <div class="{{invoice.GSTIN.GSTType != 'URD' ? 'col-auto' : 'col'}}">
                <mat-form-field>
                  <mat-select placeholder="GST Type" name="gstType" [(ngModel)]="invoice.GSTIN.GSTType">
                    <mat-option value="URD">URD</mat-option>
                    <mat-option value="RD">RD</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col" *ngIf="invoice.GSTIN.GSTType != 'URD'">
                <mat-form-field>
                  <input matInput type="text" name="gstNo" placeholder="Client GST Number" [(ngModel)]="invoice.GSTIN.GSTNo" required minlength="15" maxlength="15" #gstNoField="ngModel">
                  <mat-error *ngIf="gstNoField.errors && gstNoField.errors.required">
                    GSTIN is required.
                  </mat-error>
                  <mat-error *ngIf="gstNoField.errors && (gstNoField.errors.minlength || gstNoField.errors.maxlength)">
                    GSTIN should be 15 characters long.
                  </mat-error>
                </mat-form-field>
              </div>
            </div>  -->
          </div>
        </div>
        <div class="col-lg">
          <div class="card mb-5 mat-elevation-z3">
            <div class="card-header">
              Remark
            </div>
            <div class="card-body">
              <mat-form-field>
                <input matInput type="text" id="remark" name="remark" placeholder="For Invoice" [(ngModel)]="invoice.remark" #remarkField="ngModel">
              </mat-form-field>
              <mat-form-field>
                <input matInput placeholder="For External Use" name="otherRemark" [(ngModel)]="invoice.otherRemark">
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <br>

      <button class="btn btn-success" type="submit" [disabled]="!invoiceForm.form.valid">Submit</button>
      <button class="btn btn-danger" type="button" (click)="cancel()">Cancel</button>
    </ng-container>
  </div>
</form>